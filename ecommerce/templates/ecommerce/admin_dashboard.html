{% extends "ecommerce/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h2>Admin Dashboard</h2>

<div class="row">
  <!-- Orders -->
  <div class="col-md-6">
    <h3>All Orders</h3>

    <!-- Orders filter -->
    <form method="get" class="mb-3">
      <select name="order_status" class="form-select form-select-sm">
        <option value="">All Statuses</option>
        <option value="pending" {% if request.GET.order_status == 'pending' %}selected{% endif %}>Pending</option>
        <option value="shipped" {% if request.GET.order_status == 'shipped' %}selected{% endif %}>Shipped</option>
        <option value="delivered" {% if request.GET.order_status == 'delivered' %}selected{% endif %}>Delivered</option>
        <option value="canceled" {% if request.GET.order_status == 'canceled' %}selected{% endif %}>Canceled</option>
      </select>
      <button type="submit" class="btn btn-primary btn-sm mt-2">Filter Orders</button>
    </form>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID</th><th>Customer</th><th>Status</th><th>Total</th><th>Paid</th><th>Balance</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for order in orders %}
        <tr>
          <td>{{ order.id }}</td>
          <td>{{ order.customer.user.username }}</td>
          <td>{{ order.status }}</td>
          <td>{{ order.get_total_amount }}</td>
          <td>{{ order.get_total_paid }}</td>
          <td>{{ order.get_outstanding_balance }}</td>
          <td>
            <form method="post" action="{% url 'update_order_status' order.id %}">
              {% csrf_token %}
              <select name="status" class="form-select form-select-sm">
                <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
              </select>
              <button type="submit" class="btn btn-sm btn-primary">Update</button>
            </form>
            <!-- ✅ Add Payment button tied to this order -->
            <a href="{% url 'add_payment' order.id %}" class="btn btn-sm btn-success mt-2">Add Payment</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Debts -->
  <div class="col-md-6">
    <h3>All Debts</h3>
    <form method="get" class="mb-3">
      <select name="debt_status" class="form-select form-select-sm">
        <option value="">All Debts</option>
        <option value="paid" {% if request.GET.debt_status == 'paid' %}selected{% endif %}>Paid</option>
        <option value="unpaid" {% if request.GET.debt_status == 'unpaid' %}selected{% endif %}>Unpaid</option>
      </select>
      <button type="submit" class="btn btn-primary btn-sm mt-2">Filter Debts</button>
    </form>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Customer</th><th>Order</th><th>Balance</th><th>Paid</th><th>Paid At</th>
        </tr>
      </thead>
      <tbody>
        {% for debt in debts %}
        <tr>
          <td>{{ debt.customer.user.username }}</td>
          <td>{{ debt.order.id }}</td>
          <td>{{ debt.order.get_outstanding_balance }}</td>
          <td>{{ debt.is_paid }}</td>
          <td>{{ debt.paid_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Payments -->
<div class="row mt-4">
  <div class="col-md-12">
    <h3>Payments</h3>
    <form method="get" class="mb-3 row">
      <div class="col-md-4">
        <select name="payment_status" class="form-select form-select-sm">
          <option value="">All Payments</option>
          <option value="pending" {% if request.GET.payment_status == 'pending' %}selected{% endif %}>Pending</option>
          <option value="completed" {% if request.GET.payment_status == 'completed' %}selected{% endif %}>Completed</option>
          <option value="failed" {% if request.GET.payment_status == 'failed' %}selected{% endif %}>Failed</option>
        </select>
      </div>
      <div class="col-md-4">
        <input type="date" name="payment_date" value="{{ request.GET.payment_date }}" class="form-control form-control-sm" />
      </div>
      <div class="col-md-4">
        <button type="submit" class="btn btn-primary btn-sm">Filter Payments</button>
      </div>
    </form>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>Order</th><th>Customer</th><th>Amount</th><th>Method</th><th>Status</th><th>Date</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for payment in payments %}
        <tr>
          <td>{{ payment.order.id }}</td>
          <td>{{ payment.order.customer.user.username }}</td>
          <td>{{ payment.amount }}</td>
          <td>{{ payment.payment_method }}</td>
          <td>{{ payment.status }}</td>
          <td>{{ payment.payment_date }}</td>
          <td>
            <!-- ✅ Corrected: use 'edit_payment' -->
            <a href="{% url 'edit_payment' payment.id %}" class="btn btn-sm btn-primary">Edit</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Products -->
<div class="row mt-4">
  <div class="col-md-12">
    <h3>Products</h3>
    <a href="{% url 'add_product' %}" class="btn btn-success mb-3">Add Product</a>

    <div class="row">
      {% for product in products %}
        <div class="col-md-4">
          <div class="card mb-4 shadow-sm">
            {% if product.image %}
              <img src="{{ product.image.url }}" class="card-img-top" alt="{{ product.name }}">
            {% endif %}
            <div class="card-body">
              <h5 class="card-title">{{ product.name }}</h5>
              <p class="card-text">{{ product.description|truncatewords:15 }}</p>
              <p><strong>Price:</strong> ksh{{ product.price }}</p>
              <p><strong>Stock:</strong> {{ product.stock }}</p>
              <div class="d-flex justify-content-between">
                <a href="{% url 'update_product' product.id %}" class="btn btn-sm btn-primary">Edit</a>
                <a href="{% url 'delete_product' product.id %}" class="btn btn-sm btn-danger">Delete</a>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}